extends frame

block pageContent
  // Header
  div(class="mb-8")
    h2(class="text-2xl font-bold text-gray-900") Demographics
    p(class="text-gray-600") Define your audience and preferences for better targeting

  // Create/Edit Demographic widget
  - var isEditing = editingDemographic && editingDemographic.id;
  - var bgClass = isEditing ? 'bg-teal-50 border-teal-200 border' : 'bg-white';
  div(class=`${bgClass} rounded-xl shadow p-6 mb-8`)
    h3(class="text-lg font-semibold text-gray-900 mb-4")= isEditing ? 'Edit demographic' : 'Add demographic'
    form(action="/demographics" method="POST" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4")
      if isEditing
        input(type="hidden" name="id" value=editingDemographic.id)
      // Name
      div(class="md:col-span-2 lg:col-span-3")
        label(for="dg_name" class="block text-sm font-medium text-gray-700 mb-2") Name
        - var nameValue = isEditing && editingDemographic.name ? editingDemographic.name : '';
        input(type="text" id="dg_name" name="name" value=nameValue placeholder="Name of the targeted demographic" class="w-full px-4 py-3 text-xl border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" required)

      div(class="grid grid-cols-3 gap-4")
        div
          label(for="dg_gender" class="block text-sm font-medium text-gray-700 mb-2") Gender
          - var genderValue = isEditing && editingDemographic.gender ? editingDemographic.gender : 'all';
          select(id="dg_gender" name="gender" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent")
            option(value="male" selected=(genderValue === 'male')) Male
            option(value="female" selected=(genderValue === 'female')) Female
            option(value="non-binary" selected=(genderValue === 'non-binary')) Non-binary
            option(value="all" selected=(genderValue === 'all')) All
        div
          label(for="dg_age_min" class="block text-sm font-medium text-gray-700 mb-2") Age min
          - var ageRange = isEditing && editingDemographic.age_range ? (typeof editingDemographic.age_range === 'string' ? (function(s){ try { return JSON.parse(s); } catch(e){ return {}; } })(editingDemographic.age_range) : editingDemographic.age_range) : {};
          - var ageMin = ageRange && ageRange.min !== null && ageRange.min !== undefined ? ageRange.min : '';
          input(type="number" id="dg_age_min" name="age_min" value=ageMin class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent")
        div
          label(for="dg_age_max" class="block text-sm font-medium text-gray-700 mb-2") Age max
          - var ageMax = ageRange && ageRange.max !== null && ageRange.max !== undefined ? ageRange.max : '';
          input(type="number" id="dg_age_max" name="age_max" value=ageMax class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent")
      
      div(class="grid grid-cols-4 gap-4")
        div(class="col-span-1")
          label(for="dg_country" class="block text-sm font-medium text-gray-700 mb-2") Country
          - var location = isEditing && editingDemographic.location ? (typeof editingDemographic.location === 'string' ? (function(s){ try { return JSON.parse(s); } catch(e){ return {}; } })(editingDemographic.location) : editingDemographic.location) : {};
          - var countryValue = location && location.country ? location.country : '';
          select(id="dg_country" name="country" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent")
            option(value="") Select
            option(value="RO" selected=(countryValue === 'RO')) ðŸ‡·ðŸ‡´ RO
        div(class="col-span-1")
          label(for="dg_language" class="block text-sm font-medium text-gray-700 mb-2") Language
          - var langValue = isEditing && editingDemographic.language ? editingDemographic.language : '';
          select(id="dg_language" name="language" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent")
            option(value="") Select
            option(value="ro" selected=(langValue === 'ro')) ðŸ‡·ðŸ‡´ RO
            option(value="en" selected=(langValue === 'en')) ðŸ‡¬ðŸ‡§ EN
            option(value="de" selected=(langValue === 'de')) ðŸ‡©ðŸ‡ª DE 
        div(class="col-span-2")
          label(for="dg_city" class="block text-sm font-medium text-gray-700 mb-2") City
          - var cityValue = location && location.city ? location.city : '';
          input(type="text" id="dg_city" name="city" value=cityValue class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent")

      div(class="grid grid-cols-2 gap-4")
        div(class="col-span-1")
          label(for="dg_income_min" class="block text-sm font-medium text-gray-700 mb-2") Income min
          - var income = isEditing && editingDemographic.income ? (typeof editingDemographic.income === 'string' ? (function(s){ try { return JSON.parse(s); } catch(e){ return {}; } })(editingDemographic.income) : editingDemographic.income) : {};
          - var incomeMin = income && income.min !== null && income.min !== undefined ? income.min : '';
          input(type="number" id="dg_income_min" name="income_min" value=incomeMin class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent")
        div(class="col-span-1")
          label(for="dg_income_max" class="block text-sm font-medium text-gray-700 mb-2") Income max
          - var incomeMax = income && income.max !== null && income.max !== undefined ? income.max : '';
          input(type="number" id="dg_income_max" name="income_max" value=incomeMax class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent")


      // Education + Interests (3-part row: education 1, interests 2)
      div(class="md:col-span-2 lg:col-span-3")
        div(class="grid grid-cols-1 lg:grid-cols-3 gap-4")
          // Education (left, 1 part)
          div(class="col-span-1")
            label(for="dg_education" class="block text-sm font-medium text-gray-700 mb-2") Education
            - var eduValue = isEditing && editingDemographic.education ? editingDemographic.education : '';
            select(id="dg_education" name="education" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent")
              option(value="") Select
              option(value="elementary" selected=(eduValue === 'elementary')) Elementary
              option(value="high_school" selected=(eduValue === 'high_school')) High School
              option(value="bachelor" selected=(eduValue === 'bachelor')) Bachelor
              option(value="master" selected=(eduValue === 'master')) Master
              option(value="phd" selected=(eduValue === 'phd')) PhD
          // Interests (right, 2 parts)
          div(class="col-span-1 lg:col-span-2")
            label(for="dg_interests_editor" class="block text-sm font-medium text-gray-700 mb-2") Interests
            // Hidden field that will carry comma-separated values
            - var interestsValue = '';
            if isEditing && editingDemographic.interests
              - var intsRaw = editingDemographic.interests;
              - var ints = Array.isArray(intsRaw) ? intsRaw : (typeof intsRaw === 'string' ? intsRaw.split(',').map(function(s){return s.trim();}).filter(function(s){return s.length > 0;}) : []);
              - interestsValue = ints.join(',');
            input(type="hidden" id="dg_interests" name="interests" value=interestsValue)
            // Tag editor box styled like inputs; type comma or Enter to add
            div(id="dg_interests_tagbox" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-purple-500 focus-within:border-transparent min-h-[42px] flex flex-wrap items-center gap-2")
              // Tags will be injected here
              input(type="text" id="dg_interests_editor" placeholder="Type interest and press Enter or ," class="flex-1 min-w-[140px] outline-none text-sm bg-transparent")

      // Submit button
      div(class="md:col-span-2 lg:col-span-3 flex justify-end mt-2")
        if isEditing
          a(href="/demographics" class="mr-3 px-4 py-2 rounded-lg font-medium transition-colors duration-200 border border-gray-300 text-gray-700 hover:bg-gray-50") Cancel
        button(type="submit" class="inline-flex items-center justify-center px-4 py-2 rounded-lg font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-teal-400 text-white hover:bg-purple-900 focus:ring-purple-500")
          i(data-lucide="save" class="w-4 h-4 mr-2")
          = isEditing ? 'Update demographic' : 'Add demographic'

  // Demographics table
  div(class="bg-white rounded-xl shadow overflow-hidden")
    div(class="px-6 py-4 border-b border-gray-200 flex items-center justify-between")
      h3(class="text-lg font-semibold text-gray-900") Current demographics
    if demographics && demographics.length
      div(class="overflow-x-auto")
        table(class="min-w-full divide-y divide-gray-200")
          thead(class="bg-gray-50")
            tr
              th(class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider") Name
              th(class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider") Age Range
              th(class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider") Gender
              th(class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider") Location
              th(class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider") Language
              th(class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider") Income
              th(class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider") Interests
          tbody(class="bg-white divide-y divide-gray-200")
            each d in demographics
              - var ar = (d && d.age_range) ? (typeof d.age_range === 'string' ? (function(s){ try { return JSON.parse(s); } catch(e){ return {}; } })(d.age_range) : d.age_range) : {};
              - var arHas = (ar && ((ar.min !== undefined && ar.min !== null) || (ar.max !== undefined && ar.max !== null)));
              - var loc = (d && d.location) ? (typeof d.location === 'string' ? (function(s){ try { return JSON.parse(s); } catch(e){ return {}; } })(d.location) : d.location) : {};
              - var inc = (d && d.income) ? (typeof d.income === 'string' ? (function(s){ try { return JSON.parse(s); } catch(e){ return {}; } })(d.income) : d.income) : {};
              - var incHas = (inc && ((inc.min !== undefined && inc.min !== null) || (inc.max !== undefined && inc.max !== null)));
              - var g = (d && d.gender) ? d.gender : null;
              - var gLabel = '-';
              - if (typeof g === 'string' && g.length) { gLabel = g; }
              - else if (Array.isArray(g) && g.length) { gLabel = g.join(', '); }
              - else if (g && typeof g === 'object' && !Array.isArray(g)) {
              -   if (g.male === 100 && g.female === 0) gLabel = 'male';
              -   else if (g.male === 0 && g.female === 100) gLabel = 'female';
              -   else if (g.male != null || g.female != null) gLabel = `male ${g.male || 0}% / female ${g.female || 0}%`;
              - }
              - var intsRaw = (d && d.interests) ? d.interests : [];
              - var ints = Array.isArray(intsRaw) ? intsRaw : (typeof intsRaw === 'string' ? intsRaw.split(',').map(function(s){return s.trim();}).filter(function(s){return s.length > 0;}) : []);
              tr
                td(class="px-6 py-4 whitespace-nowrap text-sm")
                  a(href=`/demographics?id=${d.id}` class="text-purple-600 hover:text-purple-900 hover:underline font-medium")= d.name
                td(class="px-6 py-4 whitespace-nowrap text-sm text-gray-700")= arHas ? `${(ar.min !== undefined && ar.min !== null) ? ar.min : '-'} - ${(ar.max !== undefined && ar.max !== null) ? ar.max : '-'}` : '-'
                td(class="px-6 py-4 whitespace-nowrap text-sm text-gray-700")= gLabel
                - var hasCountry = (loc && loc.country !== undefined && loc.country !== null && String(loc.country).length > 0);
                - var hasCity = (loc && loc.city !== undefined && loc.city !== null && String(loc.city).length > 0);
                td(class="px-6 py-4 whitespace-nowrap text-sm text-gray-700")= (hasCountry || hasCity) ? `${hasCountry ? loc.country : ''}${(hasCountry && hasCity) ? ', ' : ''}${hasCity ? loc.city : ''}` : '-'
                td(class="px-6 py-4 whitespace-nowrap text-sm text-gray-700")= d.language || '-'
                td(class="px-6 py-4 whitespace-nowrap text-sm text-gray-700")= incHas ? `${(inc.min !== undefined && inc.min !== null) ? inc.min : '-'} - ${(inc.max !== undefined && inc.max !== null) ? inc.max : '-'}` : '-'
                td(class="px-6 py-4 whitespace-nowrap text-sm text-gray-700")= (Array.isArray(ints) && ints.length) ? ints.join(', ') : '-'
    else
      div(class="px-6 py-6 text-gray-600") No demographics yet.


