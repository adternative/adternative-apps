extends ../../../views/layout

block content
  // Page header
  div(class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6 mb-8")
    div(class="flex items-center justify-between")
      div
        h2(class="text-2xl font-bold text-gray-900 tracking-tight") Subscribers
        p(class="text-gray-600") Manage subscribers and tags
      div
        a(href="#create-subscriber" class="inline-flex items-center px-4 py-2 rounded-xl font-medium bg-blue-600 text-white hover:bg-blue-700 transition")
          i(data-lucide="user-plus" class="w-4 h-4 mr-2")
          | Add subscriber

  // Filter by Audience
  div(class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6 mb-6")
    form(method="GET" action="/pulse/subscribers" class="grid grid-cols-1 md:grid-cols-4 gap-4")
      div(class="md:col-span-3")
        label(for="audFilter" class="block text-sm font-medium text-gray-700 mb-1") Audience filter
        select(id="audFilter" name="audience_id" class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
          option(value="" selected=!selectedAudienceId) All audiences
          if audiences && audiences.length
            each a in audiences
              option(value=a.id selected=(String(selectedAudienceId)===String(a.id)))= a.name
      div(class="md:col-span-1 flex items-end space-x-2")
        button(type="submit" class="w-full inline-flex items-center justify-center px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm transition")
          i(data-lucide="check" class="w-4 h-4 mr-2")
          | Apply

  // List
  div(class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6 mb-6")
    div(class="flex items-center justify-between mb-4")
      h3(class="text-lg font-medium text-gray-900") Existing Subscribers
    // header row
    div(class="hidden md:grid md:grid-cols-3 text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 px-2")
      div Email
      div Name
      div(class="text-right") Actions
    ul(id="subsList" class="divide-y divide-gray-200")
      if !subscribers || subscribers.length === 0
        li(class="text-gray-500 text-sm py-2") No subscribers yet.
      else
        each s in subscribers
          li(class="py-3")
            div(class="flex items-center justify-between")
              div
                div(class="font-medium text-gray-900")= s.email
                div(class="text-sm text-gray-500") #{s.first_name || ''} #{s.last_name || ''}
              div
                button(data-id=s.id class="deleteSub px-3 py-1.5 rounded bg-red-50 text-red-700 hover:bg-red-100 text-sm") Delete

  // Create
  div(id="create-subscriber" class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6")
    h3(class="text-lg font-medium text-gray-900 mb-4") Add Subscriber
    form(id="createSubForm" class="grid grid-cols-1 md:grid-cols-3 gap-4")
      div
        label(for="audience_id" class="block text-sm font-medium text-gray-700 mb-1") Audience
        select(name="audience_id" id="audience_id" required class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
          if audiences && audiences.length
            each a in audiences
              option(value=a.id)= a.name
      div
        label(for="email" class="block text-sm font-medium text-gray-700 mb-1") Email
        input(type="email" name="email" id="email" required class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div
        label(for="first_name" class="block text-sm font-medium text-gray-700 mb-1") First name
        input(type="text" name="first_name" id="first_name" class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div
        label(for="last_name" class="block text-sm font-medium text-gray-700 mb-1") Last name
        input(type="text" name="last_name" id="last_name" class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div(class="md:col-span-3 flex justify-end")
        button(type="submit" class="inline-flex items-center px-4 py-2 rounded-xl font-medium bg-blue-600 text-white hover:bg-blue-700 transition")
          i(data-lucide="plus" class="w-4 h-4 mr-2")
          | Add Subscriber

  script.
    document.querySelectorAll('.deleteSub').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const id = btn.getAttribute('data-id');
        if (!confirm('Delete this subscriber?')) return;
        const delRes = await fetch(`/pulse/subscribers/${id}`, { method: 'DELETE' });
        await delRes.json();
        window.location.reload();
      });
    });
    document.getElementById('createSubForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const payload = Object.fromEntries(new FormData(form).entries());
      const res = await fetch('/pulse/subscribers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (json.success) {
        form.reset();
        window.location.reload();
      } else {
        alert(json.error?.message || 'Failed to add subscriber');
      }
    });
    


