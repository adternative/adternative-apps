extends ../../../views/frame

block pageContent
  // Page header
  div(class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6 mb-8")
    div(class="flex items-center justify-between")
      div
        h2(class="text-2xl font-bold text-gray-900 tracking-tight") Audiences
        p(class="text-gray-600") Create and manage your audiences
      div(class="flex items-center space-x-3")
        a(href="#create-audience" class="inline-flex items-center px-4 py-2 rounded-xl font-medium bg-blue-600 text-white hover:bg-blue-700 transition")
          i(data-lucide="plus" class="w-4 h-4 mr-2")
          | New audience

  // List
  div(class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6 mb-6")
    div(class="flex items-center justify-between mb-4")
      h3(class="text-lg font-medium text-gray-900") Existing Audiences
      a(href="/pulse/audiences" class="inline-flex items-center px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm transition")
        i(data-lucide="refresh-ccw" class="w-4 h-4 mr-2")
        | Refresh
    // header row
    div(class="hidden md:grid md:grid-cols-3 text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 px-2")
      div Name
      div From Email
      div(class="text-right") Actions
    ul(id="audiencesList" class="divide-y divide-gray-200")
      if !audiences || audiences.length === 0
        li(class="text-gray-500 text-sm py-2") No audiences yet.
      else
        each a in audiences
          li(class="py-3")
            div(class="flex items-center justify-between")
              div
                div(class="font-medium text-gray-900")= a.name
                div(class="text-sm text-gray-500")= a.default_from_email || ''
              div
                button(data-id=a.id class="deleteAudience px-3 py-1.5 rounded bg-red-50 text-red-700 hover:bg-red-100 text-sm") Delete

  // Create
  div(id="create-audience" class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6")
    h3(class="text-lg font-medium text-gray-900 mb-4") Create Audience
    form(id="createAudienceForm" class="grid grid-cols-1 md:grid-cols-2 gap-4")
      input(type="hidden" id="entity_id" name="entity_id" value=(currentEntity && currentEntity.id) )
      div
        label(for="name" class="block text-sm font-medium text-gray-700 mb-1") Name
        input(type="text" name="name" id="name" required class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div
        label(for="default_from_name" class="block text-sm font-medium text-gray-700 mb-1") From Name
        input(type="text" name="default_from_name" id="default_from_name" class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div
        label(for="default_from_email" class="block text-sm font-medium text-gray-700 mb-1") From Email
        input(type="email" name="default_from_email" id="default_from_email" class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div
        label(for="default_subject" class="block text-sm font-medium text-gray-700 mb-1") Default Subject
        input(type="text" name="default_subject" id="default_subject" class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div(class="md:col-span-2")
        label(for="description" class="block text-sm font-medium text-gray-700 mb-1") Description
        textarea(name="description" id="description" rows="3" class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div(class="md:col-span-2 flex justify-end")
        button(type="submit" class="inline-flex items-center px-4 py-2 rounded-xl font-medium bg-blue-600 text-white hover:bg-blue-700 transition")
          i(data-lucide="plus" class="w-4 h-4 mr-2")
          | Create Audience

  script.
    document.querySelectorAll('.deleteAudience').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const id = btn.getAttribute('data-id');
        if (!confirm('Delete this audience?')) return;
        const delRes = await fetch(`/pulse/audiences/${id}`, { method: 'DELETE' });
        await delRes.json();
        window.location.reload();
      });
    });
    document.getElementById('createAudienceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const payload = Object.fromEntries(new FormData(form).entries());
      const res = await fetch('/pulse/audiences', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (json.success) {
        form.reset();
        window.location.reload();
      } else {
        alert(json.error?.message || 'Failed to create audience');
      }
    });
    


