extends ../../../views/layout

block content
  // Page header
  div(class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6 mb-8")
    div(class="flex items-center justify-between")
      div
        h2(class="text-2xl font-bold text-gray-900 tracking-tight") Templates
        p(class="text-gray-600") Create and manage email templates
      div
        a(href="#create-template" class="inline-flex items-center px-4 py-2 rounded-xl font-medium bg-blue-600 text-white hover:bg-blue-700 transition")
          i(data-lucide="file-plus" class="w-4 h-4 mr-2")
          | New template

  // List
  div(class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6 mb-6")
    div(class="flex items-center justify-between mb-4")
      h3(class="text-lg font-medium text-gray-900") Existing Templates
      a(href="/pulse/templates" class="inline-flex items-center px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm transition")
        i(data-lucide="refresh-ccw" class="w-4 h-4 mr-2")
        | Refresh
    // header row
    div(class="hidden md:grid md:grid-cols-3 text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 px-2")
      div Name
      div Subject
      div(class="text-right") Actions
    ul(id="templatesList" class="divide-y divide-gray-200")
      if !templates || templates.length === 0
        li(class="text-gray-500 text-sm py-2") No templates yet.
      else
        each t in templates
          li(class="py-3")
            div(class="flex items-center justify-between")
              div
                div(class="font-medium text-gray-900")= t.name
                div(class="text-sm text-gray-500")= t.subject || ''
              div
                button(data-id=t.id class="deleteTemplate px-3 py-1.5 rounded bg-red-50 text-red-700 hover:bg-red-100 text-sm") Delete

  // Create
  div(id="create-template" class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-6")
    h3(class="text-lg font-medium text-gray-900 mb-4") Create Template
    form(id="createTemplateForm" class="grid grid-cols-1 gap-4")
      input(type="hidden" id="entity_id" name="entity_id" value=(currentEntity && currentEntity.id) )
      div
        label(for="name" class="block text-sm font-medium text-gray-700 mb-1") Name
        input(type="text" name="name" id="name" required class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div
        label(for="subject" class="block text-sm font-medium text-gray-700 mb-1") Subject
        input(type="text" name="subject" id="subject" class="w-full border rounded-lg px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div
        label(for="html" class="block text-sm font-medium text-gray-700 mb-1") HTML
        textarea(name="html" id="html" rows="8" required class="w-full border rounded-lg px-3 py-2 text-gray-900 font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div
        label(for="text" class="block text-sm font-medium text-gray-700 mb-1") Text (fallback)
        textarea(name="text" id="text" rows="4" class="w-full border rounded-lg px-3 py-2 text-gray-900 font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent")
      div(class="flex justify-end")
        button(type="submit" class="inline-flex items-center px-4 py-2 rounded-xl font-medium bg-blue-600 text-white hover:bg-blue-700 transition")
          i(data-lucide="plus" class="w-4 h-4 mr-2")
          | Create Template

  script.
    document.querySelectorAll('.deleteTemplate').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const id = btn.getAttribute('data-id');
        if (!confirm('Delete this template?')) return;
        const delRes = await fetch(`/pulse/templates/${id}`, { method: 'DELETE' });
        await delRes.json();
        window.location.reload();
      });
    });
    document.getElementById('createTemplateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const payload = Object.fromEntries(new FormData(form).entries());
      const res = await fetch('/pulse/templates', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (json.success) {
        form.reset();
        window.location.reload();
      } else {
        alert(json.error?.message || 'Failed to create template');
      }
    });
    


