extends ../../../views/layout

block content
  - const keywordTotal = typeof total === 'number' ? total : (keywords ? keywords.length : 0);

  div(class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4")
    div
      h2(class="text-3xl font-semibold text-slate-900 tracking-tight") Keyword Intelligence
      p(class="text-slate-500 mt-2") Monitor priority keywords, volatility, and SERP snapshots.
    form(action="/reverb/keywords/sync" method="post" class="inline-flex items-center gap-3 bg-white border border-slate-200 rounded-xl px-4 py-3 shadow-sm")
      input(type="hidden" name="mock" value="true")
      div
        label(for="topics" class="block text-xs font-semibold uppercase tracking-wide text-slate-500") Seed topics
        input(type="text" id="topics" name="topics" placeholder="seo intelligence, predictive seo" class="mt-1 w-64 rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:border-blue-500")
      button(type="submit" class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow hover:bg-blue-700 transition")
        i(data-lucide="refresh-cw" class="w-4 h-4")
        | Sync keywords

  if feedback && feedback.status
    div(class=(feedback.status === 'success' ? 'bg-emerald-50 border border-emerald-200 text-emerald-700' : 'bg-red-50 border border-red-200 text-red-700') + ' rounded-xl px-4 py-3 mb-6 text-sm flex items-start gap-3')
      i(data-lucide=feedback.status === 'success' ? 'check-circle' : 'alert-triangle' class="w-4 h-4 mt-0.5")
      span #{feedback.message || (feedback.status === 'success' ? 'Keywords refreshed successfully.' : 'Unable to refresh keywords.')}

  div(class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6")
    div(class="flex items-center justify-between mb-4")
      h3(class="text-lg font-semibold text-slate-900") Tracked keywords
      span(class="text-xs text-slate-400 uppercase tracking-wide") Showing #{keywords ? keywords.length : 0} of #{keywordTotal}
    if keywords && keywords.length
      table(class="w-full text-sm text-left text-slate-600 border-t border-slate-200")
        thead
          tr(class="text-xs uppercase text-slate-500 tracking-wide")
            th(class="py-3") Keyword
            th(class="py-3") Intent
            th(class="py-3") Position
            th(class="py-3") Difficulty
            th(class="py-3") Volatility
            th(class="py-3") Actions
        tbody
          each keyword in keywords
            - const latest = keyword.snapshots && keyword.snapshots.length ? keyword.snapshots[0] : null;
            - const position = latest && latest.position !== undefined && latest.position !== null ? latest.position : '—';
            - const prev = latest && latest.previousPosition !== undefined && latest.previousPosition !== null ? latest.previousPosition : null;
            - const movement = prev !== null && position !== '—' ? prev - position : null;
            - const difficulty = latest && latest.difficulty !== undefined ? latest.difficulty : '—';
            - const volatility = latest && latest.serpVolatility ? Math.round(latest.serpVolatility * 100) + '%' : '—';
            tr(class="border-t border-slate-200 hover:bg-slate-50 transition")
              td(class="py-3 font-medium text-slate-800") #{keyword.keyword}
              td(class="py-3 text-slate-500 capitalize") #{keyword.intent || '—'}
              td(class="py-3")
                span(class="inline-flex items-center gap-2")
                  span #{position}
                  if movement !== null
                    span(class=["text-xs font-semibold", movement > 0 ? 'text-emerald-500' : movement < 0 ? 'text-red-500' : 'text-slate-400']) #{movement > 0 ? '▲ +' + movement : movement < 0 ? '▼ ' + movement : '↔'}
              td(class="py-3") #{difficulty}
              td(class="py-3") #{volatility}
              td(class="py-3")
                div(class="flex flex-wrap gap-2")
                  form(action="/reverb/keywords/" + keyword.id + "/capture-serp" method="post" class="inline-flex")
                    button(type="submit" class="inline-flex items-center gap-1 rounded-lg border border-slate-200 px-3 py-1 text-xs font-medium text-slate-600 hover:border-blue-500 hover:text-blue-600 transition")
                      i(data-lucide="camera" class="w-3 h-3")
                      | SERP snapshot
                  a(href="/reverb/keywords/" + keyword.id + "/rank-history" class="inline-flex items-center gap-1 rounded-lg border border-slate-200 px-3 py-1 text-xs font-medium text-slate-600 hover:border-blue-500 hover:text-blue-600 transition")
                    i(data-lucide="chart-line" class="w-3 h-3")
                    | Rank history
    else
      p(class="text-sm text-slate-500") No keywords yet. Sync them above to generate SERP snapshots and tracking.

