extends ../../../views/layout

block content
  - const insightList = insights || [];
  - const predictiveSummary = predictive || {};

  div(class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4")
    div
      h2(class="text-3xl font-semibold text-slate-900 tracking-tight") Insights & predictive
      p(class="text-slate-500 mt-2") AI-assisted recommendations, volatility alerts, and topic opportunities.
    form(action="/reverb/insights/predictive" method="post" class="inline-flex items-center gap-3 bg-white border border-slate-200 rounded-xl px-4 py-3 shadow-sm")
      div
        label(for="predictiveKeyword" class="block text-xs font-semibold uppercase tracking-wide text-slate-500") Keyword focus
        input(type="text" id="predictiveKeyword" name="keyword" value=keyword class="mt-1 w-64 rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:border-blue-500")
      div
        label(for="predictiveUrl" class="block text-xs font-semibold uppercase tracking-wide text-slate-500") Target URL
        input(type="text" id="predictiveUrl" name="url" value=predictiveUrl class="mt-1 w-72 rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:border-blue-500")
      button(type="submit" class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow hover:bg-blue-700 transition")
        i(data-lucide="sparkles" class="w-4 h-4")
        | Refresh predictive

  if feedback && feedback.status
    div(class=(feedback.status === 'success' ? 'bg-emerald-50 border border-emerald-200 text-emerald-700' : 'bg-red-50 border border-red-200 text-red-700') + ' rounded-xl px-4 py-3 mb-6 text-sm flex items-start gap-3')
      i(data-lucide=feedback.status === 'success' ? 'check-circle' : 'alert-triangle' class="w-4 h-4 mt-0.5")
      span #{feedback.message || (feedback.status === 'success' ? 'Predictive insights refreshed.' : 'Unable to refresh predictive insights.')}

  div(class="grid grid-cols-1 lg:grid-cols-2 gap-6")
    div(class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6")
      h3(class="text-lg font-semibold text-slate-900 mb-4") AI signals
      if insightList.length
        ul(class="space-y-4 text-sm text-slate-600")
          each insight in insightList
            li(class="border border-slate-200 rounded-xl p-4")
              div(class="flex items-center justify-between")
                span(class="text-xs uppercase font-semibold tracking-wide text-blue-500") #{insight.category ? insight.category.replace('_', ' ') : 'insight'}
                if insight.confidence !== undefined && insight.confidence !== null
                  span(class="text-xs text-slate-400") Confidence #{Math.round(insight.confidence * 100)}%
              p(class="mt-2 text-slate-700") #{insight.summary || 'No summary provided.'}
              if insight.metadata
                pre(class="mt-3 text-xs bg-slate-50 text-slate-500 rounded-lg p-3 overflow-x-auto") #{JSON.stringify(insight.metadata, null, 2)}
      else
        p(class="text-sm text-slate-500") No AI insights generated yet. Refresh predictive recommendations to populate this section.

    div(class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6")
      h3(class="text-lg font-semibold text-slate-900 mb-4") Predictive analysis
      if predictiveSummary && predictiveSummary.ranking
        div(class="space-y-4 text-sm text-slate-600")
          div(class="border border-slate-200 rounded-xl p-4")
            h4(class="text-sm font-semibold text-slate-800 mb-2") Ranking outlook
            p Probability of drop: #{Math.round(predictiveSummary.ranking.probability * 100)}%
            if predictiveSummary.ranking.drivers && predictiveSummary.ranking.drivers.length
              h5(class="text-xs font-semibold uppercase tracking-wide text-slate-500 mt-3 mb-1") Drivers
              ul(class="list-disc pl-5 space-y-1")
                each driver in predictiveSummary.ranking.drivers
                  li #{driver}
            if predictiveSummary.ranking.recommendedActions && predictiveSummary.ranking.recommendedActions.length
              h5(class="text-xs font-semibold uppercase tracking-wide text-slate-500 mt-3 mb-1") Recommended actions
              ul(class="list-disc pl-5 space-y-1")
                each action in predictiveSummary.ranking.recommendedActions
                  li #{action}
          if predictiveSummary.refresh
            div(class="border border-slate-200 rounded-xl p-4")
              h4(class="text-sm font-semibold text-slate-800 mb-2") Content refresh
              p Urgency: #{predictiveSummary.refresh.urgency}
              if predictiveSummary.refresh.summary
                p(class="mt-2 text-slate-600") #{predictiveSummary.refresh.summary}
              if predictiveSummary.refresh.outlineIdeas && predictiveSummary.refresh.outlineIdeas.length
                h5(class="text-xs font-semibold uppercase tracking-wide text-slate-500 mt-3 mb-1") Outline ideas
                ul(class="list-disc pl-5 space-y-1")
                  each idea in predictiveSummary.refresh.outlineIdeas
                    li #{idea}
          if predictiveSummary.topics && predictiveSummary.topics.length
            div(class="border border-slate-200 rounded-xl p-4")
              h4(class="text-sm font-semibold text-slate-800 mb-2") Emerging topics
              ul(class="space-y-2 text-slate-600")
                each topic in predictiveSummary.topics
                  li
                    span(class="font-medium text-slate-700") #{topic.topic}
                    span(class="ml-2 text-xs text-blue-500") Growth #{Math.round(topic.growthRate * 100)}%
                    if topic.suggestedFormat
                      span(class="block text-xs text-slate-400 mt-1") Suggested format: #{topic.suggestedFormat}
      else
        p(class="text-sm text-slate-500") Predictive insights are not yet available. Use the form above to generate forecasts.

